# This file defines automated storage transfers from pusher-* to archive-*
# and, for production, from archive-mlab-oti to archive-measurement-lab
# The overall schedule is (all times UTC):
# pusher ->         archive: 02:30, 08:30, 14:30, 20:30
# oti    -> measurement-lab: 04:30, 10:30, 16:30, 22:30
# There is some concern whether the 2 hour delay is sufficient to avoid
# missing files in the latter transfer.  We may adjust this after observing
# for several days.
options:
  env:
  - PROJECT_ID=$PROJECT_ID

steps:
# Create the gcp-config image for later steps.
- name: gcr.io/cloud-builders/docker
  args: [
    'build', '-t', 'gcp-config-cbif', '.'
  ]

# 02:00:00 Nodes upload to the pusher-* bucket. 2hrs is the maximum upload delay.
# 02:10:00 Last upload from utilization/switch archives.
# 02:30:00 Configure daily pusher to local archive transfer.
- name: gcp-config-cbif
  env:
  - PROJECT_IN=mlab-sandbox,mlab-staging,mlab-oti
  args: [
    'stctl', '-gcs.source=pusher-$PROJECT_ID',
             '-gcs.target=archive-$PROJECT_ID',
             '-time=02:30:00',
             '-minFileAge=10m',
             '-maxFileAge=12h',
             '-include=ndt',
             '-include=host',
             '-include=neubot',
             '-include=utilization',
             '-include=wehe',
             'sync'
  ]

# 04:30:00 Configure daily local archive to public archive transfer.
# NOTE that this transfer is only 1.5 hours after the previous transfer.
# The other transfers are staggered by 3 hours, and we should consider
# making this one 3 hours as well, but that would increase the latency
# before the data is available for parsing.
- name: gcp-config-cbif
  env:
  - PROJECT_IN=measurement-lab
  args: [
    'stctl', '-gcs.source=archive-mlab-oti',
             '-gcs.target=archive-measurement-lab',
             '-time=04:30:00',
             '-minFileAge=10m',
             '-maxFileAge=12h',
             'sync'
  ]

# Repeat transfers every 6 hours, so that the final transfer
# has less data to move, and can complete more quickly.

# 08:30:00 Configure daily pusher to local archive transfer.
- name: gcp-config-cbif
  env:
  - PROJECT_IN=mlab-sandbox,mlab-staging,mlab-oti
  args: [
    'stctl', '-gcs.source=pusher-$PROJECT_ID',
             '-gcs.target=archive-$PROJECT_ID',
             '-time=08:30:00',
             '-minFileAge=10m',
             '-maxFileAge=12h',
             '-include=ndt',
             '-include=host',
             '-include=neubot',
             '-include=utilization',
             '-include=wehe',
             'sync'
  ]

# 10:30:00 Configure daily local archive to public archive transfer.
- name: gcp-config-cbif
  env:
  - PROJECT_IN=measurement-lab
  args: [
    'stctl', '-gcs.source=archive-mlab-oti',
             '-gcs.target=archive-measurement-lab',
             '-time=10:30:00',
             '-minFileAge=10m',
             '-maxFileAge=12h',
             'sync'
  ]


# 14:30:00 Configure daily pusher to local archive transfer.
# For this one, maxFileAge is set to 7 days, to catch stragglers.
# This likely means the calculating phase will take much longer, but this
# transfer is 12 hours offset from the last transfer of the day
# preceeding the daily parsing kickoff.
- name: gcp-config-cbif
  env:
  - PROJECT_IN=mlab-sandbox,mlab-staging,mlab-oti
  args: [
    'stctl', '-gcs.source=pusher-$PROJECT_ID',
             '-gcs.target=archive-$PROJECT_ID',
             '-time=14:30:00',
             '-minFileAge=10m',
             '-maxFileAge=168h',  # 7 days
             '-include=ndt',
             '-include=host',
             '-include=neubot',
             '-include=utilization',
             '-include=wehe',
             'sync'
  ]

# 16:30:00 Configure daily local archive to public archive transfer.
# For this one, maxFileAge is set to 8 days, to catch stragglers.
# This likely means the calculating phase will take much longer.
- name: gcp-config-cbif
  env:
  - PROJECT_IN=measurement-lab
  args: [
    'stctl', '-gcs.source=archive-mlab-oti',
             '-gcs.target=archive-measurement-lab',
             '-time=16:30:00',
             '-minFileAge=10m',
             '-maxFileAge=192h',  # 8 days
             'sync'
  ]


# 20:30:00 Configure daily pusher to local archive transfer.
- name: gcp-config-cbif
  env:
  - PROJECT_IN=mlab-sandbox,mlab-staging,mlab-oti
  args: [
    'stctl', '-gcs.source=pusher-$PROJECT_ID',
             '-gcs.target=archive-$PROJECT_ID',
             '-time=20:30:00',
             '-minFileAge=10m',
             '-maxFileAge=12h',
             '-include=ndt',
             '-include=host',
             '-include=neubot',
             '-include=utilization',
             '-include=wehe',
             'sync'
  ]

# 22:30:00 Configure daily local archive to public archive transfer.
- name: gcp-config-cbif
  env:
  - PROJECT_IN=measurement-lab
  args: [
    'stctl', '-gcs.source=archive-mlab-oti',
             '-gcs.target=archive-measurement-lab',
             '-time=22:30:00',
             '-minFileAge=10m',
             '-maxFileAge=12h',
             'sync'
  ]

# 04:30:00 Gardener or other jobs that depend on the public archive being up to date may run.
# 04:30:00 Configure daily public archive to backup transfer.
# NOTE: mlab-backups intentionally restricts access. This configuration is documentation.
#- name: gcp-config-cbif
#  env:
#  - PROJECT_IN=mlab-backups
#  args: [
#    'stctl', '-gcs.source=archive-measurement-lab',
#             '-gcs.target=mlab-cold-storage-backup',
#             '-time=04:30:00',
#             'sync'
#  ]
